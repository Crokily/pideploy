{
  "project": "ClawDeploy",
  "branchName": "ralph/openclaw-real-deployment",
  "description": "Replace mock nginx:alpine with real OpenClaw containers: build image, generate config, wildcard SSL subdomain routing, web terminal, and end-to-end integration.",
  "qualityChecks": {
    "typecheck": "cd frontend && npx tsc --noEmit",
    "lint": "cd frontend && npm run lint",
    "build": "cd frontend && npm run build"
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Build OpenClaw Docker Image on Server",
      "description": "As a developer, I need the real OpenClaw Docker image built on the server so that instances can run actual OpenClaw gateways.",
      "acceptanceCriteria": [
        "Script scripts/build-openclaw-image.sh created",
        "Script clones https://github.com/openclaw/openclaw.git to /opt/openclaw-src (if not already present)",
        "Script runs docker build -t openclaw:local -f Dockerfile . from the cloned repo",
        "Script is idempotent (skip clone if dir exists, always rebuild image)",
        "docker images openclaw:local shows the built image after running the script",
        "Script committed to the repo"
      ],
      "priority": 1,
      "passes": false,
      "notes": "No frontend code changes. The OpenClaw Dockerfile uses node:22-bookworm base, requires pnpm and bun. Build may take 5-10 minutes. 34GB free disk should be sufficient."
    },
    {
      "id": "US-002",
      "title": "Create Instance Persistent Storage and Config Generator",
      "description": "As a developer, I need a service that creates persistent directories and generates the correct openclaw.json config file for each instance.",
      "acceptanceCriteria": [
        "New file frontend/src/lib/instance-config.ts created",
        "Function createInstanceStorage(instanceId) creates /data/clawdeploy/{instanceId}/config/ and /data/clawdeploy/{instanceId}/workspace/",
        "Function generateOpenClawConfig(params) generates valid openclaw.json with gateway.mode=local, gateway.port=18789, gateway.bind=lan, gateway.auth.mode=token + generated token, gateway.tailscale.mode=off, wizard metadata, and optional channels.telegram / channels.discord config",
        "Function generateEnvFile(params) generates .env content with optional API key env vars",
        "Function writeInstanceConfig(instanceId, config, envContent) writes openclaw.json and .env to the config directory",
        "Function removeInstanceStorage(instanceId) removes the instance directories",
        "Gateway token generated using crypto.randomBytes(32).toString('hex')",
        "Typecheck passes: cd frontend && npx tsc --noEmit",
        "Build passes: cd frontend && npm run build"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Config structure derived from OpenClaw source: agents.defaults.workspace=/home/node/.openclaw/workspace, gateway config, optional channel tokens. Directories must be writable by UID 1000 (node user in container)."
    },
    {
      "id": "US-003",
      "title": "Update Docker Service for OpenClaw Containers",
      "description": "As a developer, I need the Docker service module updated to create real OpenClaw containers with proper volumes, ports, environment variables, and resource limits.",
      "acceptanceCriteria": [
        "frontend/src/lib/docker.ts updated: createContainer accepts typed options (instanceId, gatewayToken, envVars, channelConfig)",
        "Image changed from nginx:alpine to openclaw:local",
        "Container exposes port 18789 mapped to random host port (range 10000-20000)",
        "Volumes: /data/clawdeploy/{id}/config:/home/node/.openclaw and /data/clawdeploy/{id}/workspace:/home/node/.openclaw/workspace",
        "Env vars: HOME=/home/node, TERM=xterm-256color, OPENCLAW_GATEWAY_TOKEN={token}, plus optional API key vars",
        "Container command: node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured",
        "Resource limits: 1 CPU (NanoCpus: 1000000000), 1GB memory (1073741824 bytes)",
        "Restart policy: unless-stopped, init: true",
        "createContainer returns { containerId, port, gatewayToken }",
        "New function execInContainer(containerId, command[]) for running commands inside container",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Depends on US-001 (image) and US-002 (storage). The dist/index.js path matches docker-compose.yml from OpenClaw repo. User 'node' (UID 1000) is the default in the OpenClaw image."
    },
    {
      "id": "US-004",
      "title": "Update Instance Creation API to Wire Everything Together",
      "description": "As a developer, I need the POST /api/instances endpoint to orchestrate storage creation, config generation, and container startup.",
      "acceptanceCriteria": [
        "POST /api/instances flow: (1) create DB record, (2) createInstanceStorage, (3) generateOpenClawConfig + writeInstanceConfig, (4) createContainer with Docker, (5) update DB with containerId + port + gatewayToken",
        "Prisma schema updated: add port (Int optional) and gatewayToken (String optional) fields to Instance model",
        "prisma db push succeeds",
        "prisma generate succeeds",
        "Request body accepts optional: botToken, apiKey, aiProvider (string), channel (telegram/discord or empty)",
        "Gateway token and port stored in DB",
        "On Docker failure: storage cleaned up, DB status set to error",
        "DELETE endpoint also calls removeInstanceStorage to clean volumes",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Depends on US-002, US-003. The channel field is now optional with empty string meaning 'skip'. This is the central orchestration story."
    },
    {
      "id": "US-005",
      "title": "Install Certbot Cloudflare Plugin and Obtain Wildcard SSL Certificate",
      "description": "As a developer, I need a wildcard SSL certificate for *.claw.a2a.ing using Let's Encrypt with Cloudflare DNS validation.",
      "acceptanceCriteria": [
        "Script scripts/setup-ssl-wildcard.sh created",
        "Script installs python3-certbot-dns-cloudflare package",
        "Script creates /etc/letsencrypt/cloudflare.ini with API token from CLOUDFLARE_API_TOKEN env var",
        "Script runs certbot with --dns-cloudflare authenticator for domains: claw.a2a.ing and *.claw.a2a.ing",
        "Certificate files exist at /etc/letsencrypt/live/claw.a2a.ing/",
        "Cloudflare credentials file has chmod 600",
        "Script is idempotent (checks if cert exists before requesting)",
        "Script committed (without secrets)"
      ],
      "priority": 5,
      "passes": false,
      "notes": "No frontend changes. User must: (1) create Cloudflare API token with Zone:DNS:Edit for a2a.ing, (2) add DNS A records for claw and *.claw pointing to server IP with proxy OFF. The script reads CLOUDFLARE_API_TOKEN from env."
    },
    {
      "id": "US-006",
      "title": "Configure Nginx Wildcard Reverse Proxy with Dynamic Port Resolution",
      "description": "As a developer, I need Nginx configured to route {instanceId}.claw.a2a.ing to the correct container port.",
      "acceptanceCriteria": [
        "Nginx config /etc/nginx/sites-available/claw.a2a.ing created with wildcard server block",
        "Server listens on 443 SSL with wildcard cert from US-005",
        "Server name regex: ~^(?<instance_id>.+)\\.claw\\.a2a\\.ing$",
        "Uses map directive in /etc/nginx/conf.d/clawdeploy-ports.conf for port resolution",
        "WebSocket support: proxy_set_header Upgrade and Connection headers",
        "HTTP 80 redirect to HTTPS",
        "Plain claw.a2a.ing server block returns info page or redirect",
        "New utility file frontend/src/lib/nginx.ts with function updateNginxPortMap(instances) that writes map file and reloads nginx",
        "Sudoers entry for the app user to run nginx -s reload without password",
        "nginx -t passes",
        "Symlinked to sites-enabled",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Depends on US-005. The map file format: map $instance_id $clawdeploy_port { default 0; \"id1\" 12345; }. The updateNginxPortMap function queries the database for all running instances and regenerates the file. Returns 502 for unknown instance IDs."
    },
    {
      "id": "US-007",
      "title": "Update Create Instance Form with Channel and AI Config",
      "description": "As a user, I want the instance creation form to optionally accept channel and AI provider configuration.",
      "acceptanceCriteria": [
        "/dashboard/new form updated with channel section: radio buttons for Telegram / Discord / Skip (default)",
        "Bot token input shown only when channel selected, with helper text",
        "AI Provider section: select for Anthropic / OpenAI / Gemini / OpenRouter / Skip (default)",
        "API Key input shown only when provider selected, type=password",
        "Form submits optional fields to API",
        "Validation: channel selected requires bot token; provider selected requires API key",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Keep the form clean. Skip defaults make zero-config creation possible. Helper text for bot tokens: Telegram → 'Chat with @BotFather on Telegram', Discord → 'Discord Developer Portal → Bot → Reset Token'."
    },
    {
      "id": "US-008",
      "title": "Update Instance Detail Page with Dashboard Link and Token",
      "description": "As a user, I want to see my OpenClaw Dashboard URL and gateway token on the instance detail page.",
      "acceptanceCriteria": [
        "Instance detail page shows Dashboard URL: https://{instanceId}.claw.a2a.ing",
        "URL is clickable link opening in new tab",
        "Gateway Token shown with copy button, masked by default, click to reveal",
        "Helper text: Use this token to log into your OpenClaw Dashboard",
        "Dashboard URL and token only shown when status is running",
        "GET /api/instances/[id] returns port and gatewayToken to owning user only",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "The gatewayToken was previously redacted. Now return it only to the owning user. Add a URL-based quick-login hint: users can append ?token=xxx to auto-authenticate in the OpenClaw Dashboard."
    },
    {
      "id": "US-009",
      "title": "Web Terminal Backend — Container Exec WebSocket Server",
      "description": "As a developer, I need a WebSocket server that streams a container shell to the browser for web terminal functionality.",
      "acceptanceCriteria": [
        "New file frontend/src/terminal-server.ts created — standalone Express+ws server on port 3001",
        "WebSocket endpoint: /ws/terminal/{instanceId}",
        "Authenticates via query param token (matches Clerk session token, verified server-side)",
        "Verifies instance ownership by querying the database",
        "Uses dockerode container.exec() to start bash (fallback sh) with TTY",
        "Bidirectional streaming: WS messages → exec stdin, exec stdout → WS messages",
        "Handles resize messages: JSON {type: 'resize', cols: number, rows: number}",
        "Cleanup on disconnect: kills exec process",
        "Only instance owner can connect",
        "Server starts via a separate npm script or process",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Separate from Next.js because App Router doesn't support raw WebSocket upgrades. This is a small ~100-line server. In production, run it alongside Next.js via PM2 or systemd. Use ws npm package."
    },
    {
      "id": "US-010",
      "title": "Web Terminal Frontend — xterm.js Integration",
      "description": "As a user, I want a web terminal on the instance detail page to run CLI commands inside my container.",
      "acceptanceCriteria": [
        "@xterm/xterm and @xterm/addon-fit packages installed",
        "New component frontend/src/components/WebTerminal.tsx created",
        "Component uses dynamic import (next/dynamic, ssr: false)",
        "Renders xterm.js terminal connecting to WS endpoint from US-009",
        "Terminal auto-fits to container, handles resize",
        "Open Terminal button on instance detail page (shown when status is running)",
        "Terminal opens in modal or expandable panel",
        "Reconnect button on disconnect",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "xterm.js is browser-only. Must use dynamic import. The terminal gives full CLI access for openclaw onboard, openclaw configure, openclaw channels add, etc."
    },
    {
      "id": "US-011",
      "title": "Instance Update (Rebuild) Functionality",
      "description": "As a user, I want an Update button to update OpenClaw to the latest version.",
      "acceptanceCriteria": [
        "New API endpoint POST /api/instances/[id]/update created",
        "Flow: stop container → remove container → git pull + docker build (if needed) → recreate container with same config/volumes/port → start",
        "Update button on instance detail page",
        "Button shows loading state during update",
        "Instance status changes to updating during process",
        "On failure: status set to error with message",
        "Shared image rebuild: track if rebuild in progress to avoid duplicates",
        "Typecheck passes",
        "Build passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Image rebuild is shared across all instances. Use a simple lock file to prevent concurrent rebuilds. After rebuild, only the requesting instance's container is recreated."
    },
    {
      "id": "US-012",
      "title": "End-to-End Integration Testing and Polish",
      "description": "As a developer, I need to verify the complete flow works and fix remaining issues.",
      "acceptanceCriteria": [
        "Can create instance via UI (with or without channel config)",
        "Container starts and OpenClaw gateway is reachable on mapped port",
        "{instanceId}.claw.a2a.ing loads OpenClaw Dashboard in browser",
        "Web Terminal connects and can run openclaw doctor",
        "Stop and restart preserves configuration",
        "Delete cleans up container, storage, and Nginx port map",
        "Error states handled gracefully",
        "Nginx port map regenerated correctly on all lifecycle events",
        "Typecheck passes",
        "Lint passes",
        "Build passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Integration and bug-fix story. Test with real Telegram/Discord bot tokens if available. Fix volume permissions, startup timing, WebSocket proxying, or any issues found."
    }
  ]
}
