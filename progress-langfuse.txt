## Codebase Patterns
- Observability modules in agent/orchestrator/src/observability/
- tracer.ts is the single integration point — agent-loop.ts only calls createTracer/processEvent/finalize/save
- All LangFuse calls must be try-catch wrapped (non-fatal observability)
- Config reads from env vars, loaded via systemd EnvironmentFile
- Discord notifications via outbox_messages table in /home/ubuntu/discord-agent/discord_agent.db
---
## 2026-02-22 - US-001: LangFuse Self-Hosted Deployment
- Created langfuse/docker-compose.yml with postgres:15-alpine + langfuse:2
- LangFuse v3 requires ClickHouse — switched to v2 (PostgreSQL only, lighter)
- LangFuse running on port 3500, API verified with init keys
- systemd service pideploy-langfuse.service created and enabled
- .env.langfuse created with API keys
- **Learnings:**
  - LangFuse latest (v3) needs ClickHouse — use langfuse:2 tag for simple setups
  - LANGFUSE_INIT_* env vars auto-create org/project/user/keys on first boot
  - PostgreSQL mapped to 5433 to avoid conflicts
---
## 2026-02-22 - US-002: Tracer Module Rewrite — LangFuse SDK
- Rewrote tracer.ts (196→304 lines) with dual output: LangFuse + local JSON
- LangFuse generation() for LLM turns, span() for tool executions
- All LF calls try-catch wrapped, lfEnabled flag guards missing keys
- Interfaces unchanged — agent-loop.ts zero changes needed
- **Learnings:**
  - Langfuse SDK uses Langfuse class with trace()/generation()/span() fluent API
  - generation.end() accepts usage object, span.end() accepts level/statusMessage
  - flushAsync() needed to ensure data sent before process ends
---
## 2026-02-22 - US-003: Orchestrator Config & Service Restart
- Updated pideploy-orchestrator.service to load .env.langfuse
- Restarted orchestrator — heartbeat trace appeared in LangFuse API immediately
- Created test task (instance_start) — LangFuse captured 7 observations (generations + tool spans)
- Token usage visible: input=8, output=93 for first generation
- Tags working: ['instance_start', 'failure'] / ['heartbeat', 'success']
- **Learnings:**
  - LangFuse v2 auto-creates project/keys from LANGFUSE_INIT_* env vars on first boot
  - API endpoint: GET /api/public/traces with Basic auth (publicKey:secretKey)
  - Observations include type (GENERATION/SPAN), model, usage
---
