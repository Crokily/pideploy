{
  "project": "piDeploy",
  "branchName": "ralph/langfuse-integration",
  "description": "Integrate self-hosted LangFuse observability platform into piDeploy Agent Orchestrator, replacing local JSON trace files with professional Web Dashboard visualization.",
  "qualityChecks": {
    "orchestrator-typecheck": "cd agent/orchestrator && npx tsc --noEmit",
    "frontend-typecheck": "cd agent/frontend && npx tsc --noEmit"
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "LangFuse Self-Hosted Deployment",
      "description": "As a developer, I need LangFuse running as a self-hosted service via Docker Compose with systemd auto-start.",
      "acceptanceCriteria": [
        "Directory /home/ubuntu/piDeploy/langfuse/ contains docker-compose.yml for LangFuse + PostgreSQL",
        "docker compose up -d starts LangFuse successfully",
        "LangFuse Web UI accessible at http://localhost:3500",
        "Admin account created and project initialized with API keys",
        "API keys saved to /home/ubuntu/piDeploy/agent/orchestrator/.env.langfuse (LANGFUSE_PUBLIC_KEY, LANGFUSE_SECRET_KEY, LANGFUSE_BASE_URL)",
        ".env.langfuse added to .gitignore",
        "systemd service pideploy-langfuse.service created and enabled (runs docker compose up in langfuse dir)",
        "cd agent/orchestrator && npx tsc --noEmit passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "LangFuse v3 docker-compose needs: postgres:15 + langfuse/langfuse:latest. Map LangFuse port to 3500 to avoid conflicts. PostgreSQL data volume for persistence. Use NEXTAUTH_SECRET, SALT, DATABASE_URL env vars for LangFuse."
    },
    {
      "id": "US-002",
      "title": "Tracer Module Rewrite — LangFuse SDK Integration",
      "description": "As a developer, I need the tracer to push trace/generation/span data to LangFuse while keeping local JSON fallback.",
      "acceptanceCriteria": [
        "langfuse@3.38.6 installed in agent/orchestrator/package.json",
        "tracer.ts rewritten: createTracer() creates both LangFuse trace and local AgentTrace",
        "processEvent() maps turn_start/end → LangFuse generation(), tool_execution_start/end → LangFuse span()",
        "message_end event passes token usage to LangFuse generation via usage field",
        "finalize() calls langfuse.flush() to ensure data is sent",
        "save() still writes local JSON file as fallback",
        "All LangFuse SDK calls wrapped in try-catch — failures only log warnings, never crash task execution",
        "AgentTrace / AgentSpan / Tracer interfaces unchanged — alerting.ts and eval.ts require zero changes",
        "transcript.ts removed or made optional (LangFuse captures I/O natively via generation input/output)",
        "cd agent/orchestrator && npx tsc --noEmit passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Key mapping: our generation span → lf trace.generation({ name, model, usage: { input, output }, metadata: { provider, stopReason } }). Our tool span → lf trace.span({ name, input: args, output: result, level: isError ? 'ERROR' : 'DEFAULT' }). Keep processEvent() signature identical so agent-loop.ts changes are minimal."
    },
    {
      "id": "US-003",
      "title": "Orchestrator Config & Service Restart",
      "description": "As a developer, I need the orchestrator to load LangFuse config and connect on startup, with a verified trace in the dashboard.",
      "acceptanceCriteria": [
        "config.ts exports getLangfuseConfig() returning { publicKey, secretKey, baseUrl, enabled }",
        "getLangfuseConfig() reads LANGFUSE_PUBLIC_KEY, LANGFUSE_SECRET_KEY, LANGFUSE_BASE_URL from env, returns enabled=false if keys missing",
        "pideploy-orchestrator.service EnvironmentFile includes .env.langfuse",
        "Orchestrator restart succeeds — journalctl shows LangFuse initialization log",
        "Manually create a test task (instance_start) via Prisma",
        "After task completes, LangFuse API GET /api/public/traces returns the trace",
        "Trace contains: name=instance_start, generations with model+usage, spans with tool names",
        "cd agent/orchestrator && npx tsc --noEmit passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Use LangFuse REST API to verify: curl -u public_key:secret_key http://localhost:3500/api/public/traces. The orchestrator should log 'LangFuse enabled' or 'LangFuse disabled (no keys)' on startup."
    },
    {
      "id": "US-004",
      "title": "Nginx Reverse Proxy & Dashboard Access",
      "description": "As a user, I need to access the LangFuse Dashboard via a clean URL with screenshots verifying functionality.",
      "acceptanceCriteria": [
        "LangFuse accessible via browser (either direct port or nginx reverse proxy)",
        "LangFuse Dashboard shows at least 1 task trace and 1 heartbeat trace",
        "Trace detail page displays: span timeline, tool call names, token usage, success/failure status",
        "agent-browser screenshot of LangFuse Dashboard saved as /tmp/langfuse-dashboard.png",
        "agent-browser screenshot of a trace detail page saved as /tmp/langfuse-trace-detail.png"
      ],
      "priority": 4,
      "passes": false,
      "notes": "If wildcard SSL cert covers *.claw.a2a.ing, add langfuse.claw.a2a.ing. Otherwise just use localhost:3500 with LangFuse's built-in auth. Take screenshots with agent-browser after login."
    },
    {
      "id": "US-005",
      "title": "E2E Test — Full Observability Pipeline",
      "description": "As a developer, I need an automated test script that verifies the complete observability pipeline from task creation to LangFuse trace visibility.",
      "acceptanceCriteria": [
        "agent/scripts/e2e-langfuse-test.sh created and executable",
        "Script checks: LangFuse health (HTTP 200), orchestrator running, frontend running",
        "Script creates a test task via Prisma CLI or curl",
        "Script polls task status until completed/failed (timeout 120s)",
        "Script queries LangFuse API for the trace by traceId from task result",
        "Script verifies trace has at least 1 generation and 1 span observation",
        "Script uses agent-browser to open LangFuse, navigate to trace, take screenshot",
        "Script exits 0 on all checks pass, non-zero on failure",
        "cd agent/orchestrator && npx tsc --noEmit passes",
        "cd agent/frontend && npx tsc --noEmit passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Use LangFuse API: GET /api/public/traces/{traceId} with Basic auth (publicKey:secretKey). The traceId is stored in the Task record after orchestrator processes it. agent-browser needs to login to LangFuse first (use admin credentials from docker-compose)."
    }
  ]
}
