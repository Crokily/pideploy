## Codebase Patterns
- (none yet — will be populated as stories are implemented)
---

# piDeploy Agent Orchestrator — Development Progress

## 2026-02-21 13:35 UTC - US-001: Monorepo Setup — Rename and Restructure
- Renamed clawdeploy → piDeploy
- Created monorepo: original/ (read-only) + agent/ (active dev)
- Copied frontend to agent/frontend/, verified npm install + typecheck
- Created agent/orchestrator/src/ placeholder
- Updated README.md
- **Learnings for future iterations:**
  - /data/clawdeploy/ path is hardcoded in docker.ts and instance-config.ts — keep it unchanged
  - agent/frontend has its own node_modules, independent from original
  - .git history preserved, branch is ralph/openclaw-real-deployment
---
## 2026-02-21 13:42 UTC - US-002: Orchestrator Project Scaffolding
- Created package.json, tsconfig.json, src/index.ts, src/config.ts, src/lib/logger.ts, src/lib/prisma.ts
- Prisma schema symlinked from frontend
- Model fallback: minimax-m2.5-free → glm-5-free → gemini-3-flash
- Codex used `resolveModel` wrapper to handle pi-ai getModel type constraints
- **Learnings for future iterations:**
  - pi-ai getModel has strict KnownProvider type — may need cast for custom providers
  - Prisma generate needs DATABASE_URL in env or it skips — postinstall handles this
  - ESM requires .js extensions in all relative imports
---
## 2026-02-21 14:02 UTC - US-003: Observability Foundation
- Created 6 files in src/observability/ following pi-agent-app-dev Patterns 1-4
- processEvent(event) pattern used across all modules for agentLoop integration
- Trace output to /var/log/pideploy/traces/
- **Learnings for future iterations:**
  - processEvent() pattern works well — all modules share same interface
  - agent_start event may not have all fields — use optional chaining
  - Cost tracking depends on usage.cost.total being present in message events
---
## 2026-02-21 14:06 UTC - US-004: Core Lifecycle Tools — create, start, stop
- Copied docker.ts, instance-config.ts, nginx.ts from frontend to orchestrator/src/lib/
- Created 3 tools + index.ts
- Ownership validation in all tools: query prisma for instance where userId matches
- **Learnings for future iterations:**
  - pi-agent-core Tool interface is simpler than Layer 3 ToolDefinition: execute(args) → { content, details }
  - Import path adaptation: @/lib/* → ./xxx.js (relative ESM)
  - nginx.ts needed prisma and logger import path updates
---
## 2026-02-21 14:10 UTC - US-005: Destructive & Complex Tools — delete, update
- instance_delete handles container-not-found gracefully
- instance_update has file lock + rollback (restart old container on failure)
- **Learnings:**
  - promisify(execFile) for async child_process
  - File lock with open('wx') + try/finally unlink pattern
---
## 2026-02-21 14:14 UTC - US-006: Infrastructure Tools — nginx_sync, report_result
- nginx_sync verifies with nginx -t after reload
- report_result persists to /var/log/pideploy/reports/
- All 7 custom tools complete
- **Learnings:**
  - report_result is critical for structured agent output — system prompt must enforce calling it
---
## 2026-02-21 14:19 UTC - US-007: Agent Loop + System Prompt + Bash Gate
- All tools updated to AgentTool interface (4-arg execute)
- Bash tool with 8+ blocked patterns
- System prompts: TASK_PROMPT (~500 tokens), HEARTBEAT_PROMPT (~300 tokens)
- agent-loop.ts: executeTask() + executeHeartbeat() with tracer/cost/perf/transcript
- **Learnings:**
  - AgentTool requires label + 4-arg execute, different from simple Tool
  - convertToLlm filters messages to only user/assistant/toolResult roles
  - Cost monitor isExceeded() checked after each event for fast abort
---
## 2026-02-21 14:25 UTC - US-008: DB Task Queue + API Route Adaptation
- Task model added to Prisma (status: pending/processing/completed/failed)
- Frontend API routes now submit tasks instead of direct Docker execution
- Orchestrator task-queue.ts polls every 2s for pending tasks
- index.ts updated to start poll loop on startup
- **Learnings:**
  - Prisma schema must be identical in both frontend and orchestrator
  - API returns 202 Accepted for async operations
  - GET endpoints stay synchronous (read from DB directly)
  - Frontend build (npm run build) is a stronger validation than typecheck alone
---
