## Codebase Patterns
- Frontend: Next.js 16.1.6 with App Router at frontend/
- Auth: Clerk with @clerk/nextjs, middleware at src/proxy.ts
- DB: Prisma 6.19.2 + Neon PostgreSQL, schema at frontend/prisma/schema.prisma
- Validation: Zod schemas in frontend/src/lib/instance-schema.ts
- Logging: Pino logger in frontend/src/lib/logger.ts
- Auth helper: frontend/src/lib/auth.ts with requireAuth() and isAuthErrorResponse()
- API routes: Next.js App Router at frontend/src/app/api/
- UI components: frontend/src/components/ui/ (Button, Card, Input, Select, Badge, LoadingSpinner, Modal, EmptyState)
- Layout: frontend/src/components/layout/ (DashboardLayout with Navbar + Sidebar + Clerk UserButton)
- Quality checks: cd frontend && npx tsc --noEmit && npm run lint && npm run build
- Prisma commands: cd frontend && npx prisma db push && npx prisma generate
- Port 3000 is occupied (Next.js dev), use port 8888 for any standalone service
- Git user: crokily <crokily@gmail.com>
---

# Ralph Progress Log
Started: 2026-02-14
---

## 2026-02-14 07:45 - US-001: Update Prisma Schema with OpenClaw Instance Fields
- Updated frontend/prisma/schema.prisma with model, channel, botToken, apiKey, containerId, config fields
- Made region and instanceType optional for backward compatibility
- Ran prisma db push and prisma generate successfully
- **Learnings for future iterations:**
  - DATABASE_URL is in frontend/.env.local but also in backend/.env
  - Prisma generate updates the client types automatically
  - Json fields need @default("{}") not @default({})
---

## 2026-02-14 07:50 - US-002: Update Zod Validation Schemas and CRUD API Routes
- Updated instance-schema.ts with model/channel enums, new optional fields
- Updated POST route to write all new fields
- Updated PATCH route with JSON null normalization for Prisma
- **Learnings for future iterations:**
  - z.json() from zod v4 for JSON fields, need Prisma.JsonNull normalization
  - createInstanceSchema uses z.enum() for model and channel
---

## 2026-02-14 07:55 - US-003: Install Docker Engine on the Server
- Created scripts/install-docker.sh (idempotent Docker installer)
- Docker Engine 29.2.1 installed via official apt repo
- ubuntu user added to docker group
- nginx:alpine image pulled
- **Learnings for future iterations:**
  - Docker socket at /var/run/docker.sock
  - Need `sg docker -c "command"` or new shell for group to take effect
  - Docker images available: nginx:alpine, hello-world
---

## 2026-02-14 08:00 - US-004: Create Docker Service Module
- Created frontend/src/lib/docker.ts with dockerode wrapper
- Functions: createContainer, startContainer, stopContainer, removeContainer, getContainerStatus, getContainerLogs, pingDocker
- Uses nginx:alpine, port range 10000-20000, CPU/memory limits
- **Learnings for future iterations:**
  - Docker module at frontend/src/lib/docker.ts
  - import { createContainer, startContainer, ... } from "@/lib/docker"
  - Container names: clawdeploy-{instanceId}
  - Labels: clawdeploy=true, instanceId=X
---

## 2026-02-14 08:05 - US-005: Integrate Docker with Instance Creation and Deletion APIs
- POST /api/instances now creates Docker container after DB insert
- DELETE /api/instances/[id] now removes container before DB delete
- Added serverExternalPackages: ["dockerode", "ssh2"] to next.config.ts
- **Learnings for future iterations:**
  - next.config.ts needs serverExternalPackages for dockerode to work in API routes
  - Docker operations wrapped in try/catch so DB ops continue even if Docker fails
---
