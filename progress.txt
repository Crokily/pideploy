## Codebase Patterns
- (none yet — will be populated as stories are implemented)
---

# piDeploy Agent Orchestrator — Development Progress

## 2026-02-21 13:35 UTC - US-001: Monorepo Setup — Rename and Restructure
- Renamed clawdeploy → piDeploy
- Created monorepo: original/ (read-only) + agent/ (active dev)
- Copied frontend to agent/frontend/, verified npm install + typecheck
- Created agent/orchestrator/src/ placeholder
- Updated README.md
- **Learnings for future iterations:**
  - /data/clawdeploy/ path is hardcoded in docker.ts and instance-config.ts — keep it unchanged
  - agent/frontend has its own node_modules, independent from original
  - .git history preserved, branch is ralph/openclaw-real-deployment
---
## 2026-02-21 13:42 UTC - US-002: Orchestrator Project Scaffolding
- Created package.json, tsconfig.json, src/index.ts, src/config.ts, src/lib/logger.ts, src/lib/prisma.ts
- Prisma schema symlinked from frontend
- Model fallback: minimax-m2.5-free → glm-5-free → gemini-3-flash
- Codex used `resolveModel` wrapper to handle pi-ai getModel type constraints
- **Learnings for future iterations:**
  - pi-ai getModel has strict KnownProvider type — may need cast for custom providers
  - Prisma generate needs DATABASE_URL in env or it skips — postinstall handles this
  - ESM requires .js extensions in all relative imports
---
## 2026-02-21 14:02 UTC - US-003: Observability Foundation
- Created 6 files in src/observability/ following pi-agent-app-dev Patterns 1-4
- processEvent(event) pattern used across all modules for agentLoop integration
- Trace output to /var/log/pideploy/traces/
- **Learnings for future iterations:**
  - processEvent() pattern works well — all modules share same interface
  - agent_start event may not have all fields — use optional chaining
  - Cost tracking depends on usage.cost.total being present in message events
---
## 2026-02-21 14:06 UTC - US-004: Core Lifecycle Tools — create, start, stop
- Copied docker.ts, instance-config.ts, nginx.ts from frontend to orchestrator/src/lib/
- Created 3 tools + index.ts
- Ownership validation in all tools: query prisma for instance where userId matches
- **Learnings for future iterations:**
  - pi-agent-core Tool interface is simpler than Layer 3 ToolDefinition: execute(args) → { content, details }
  - Import path adaptation: @/lib/* → ./xxx.js (relative ESM)
  - nginx.ts needed prisma and logger import path updates
---
