## Codebase Patterns
- Frontend: Next.js 16.1.6 with App Router at frontend/
- Auth: Clerk with @clerk/nextjs, middleware at src/proxy.ts
- DB: Prisma 6.19.2 + Neon PostgreSQL, schema at frontend/prisma/schema.prisma
- Validation: Zod schemas in frontend/src/lib/instance-schema.ts
- Logging: Pino logger in frontend/src/lib/logger.ts
- Auth helper: frontend/src/lib/auth.ts with requireAuth() and isAuthErrorResponse()
- API routes: Next.js App Router at frontend/src/app/api/
- UI components: frontend/src/components/ui/ (Button, Card, Input, Select, Badge, LoadingSpinner, Modal, EmptyState)
- Layout: frontend/src/components/layout/ (DashboardLayout with Navbar + Sidebar + Clerk UserButton)
- Quality checks: cd frontend && npx tsc --noEmit && npm run lint && npm run build
- Prisma commands: cd frontend && npx prisma db push && npx prisma generate
- Port 3000 is occupied (Next.js dev), use port 8888 for any standalone service
- Git user: crokily <crokily@gmail.com>
---

# Ralph Progress Log
Started: 2026-02-14
---

## 2026-02-14 07:45 - US-001: Update Prisma Schema with OpenClaw Instance Fields
- Updated frontend/prisma/schema.prisma with model, channel, botToken, apiKey, containerId, config fields
- Made region and instanceType optional for backward compatibility
- Ran prisma db push and prisma generate successfully
- **Learnings for future iterations:**
  - DATABASE_URL is in frontend/.env.local but also in backend/.env
  - Prisma generate updates the client types automatically
  - Json fields need @default("{}") not @default({})
---

## 2026-02-14 07:50 - US-002: Update Zod Validation Schemas and CRUD API Routes
- Updated instance-schema.ts with model/channel enums, new optional fields
- Updated POST route to write all new fields
- Updated PATCH route with JSON null normalization for Prisma
- **Learnings for future iterations:**
  - z.json() from zod v4 for JSON fields, need Prisma.JsonNull normalization
  - createInstanceSchema uses z.enum() for model and channel
---

## 2026-02-14 07:55 - US-003: Install Docker Engine on the Server
- Created scripts/install-docker.sh (idempotent Docker installer)
- Docker Engine 29.2.1 installed via official apt repo
- ubuntu user added to docker group
- nginx:alpine image pulled
- **Learnings for future iterations:**
  - Docker socket at /var/run/docker.sock
  - Need `sg docker -c "command"` or new shell for group to take effect
  - Docker images available: nginx:alpine, hello-world
---

## 2026-02-14 08:00 - US-004: Create Docker Service Module
- Created frontend/src/lib/docker.ts with dockerode wrapper
- Functions: createContainer, startContainer, stopContainer, removeContainer, getContainerStatus, getContainerLogs, pingDocker
- Uses nginx:alpine, port range 10000-20000, CPU/memory limits
- **Learnings for future iterations:**
  - Docker module at frontend/src/lib/docker.ts
  - import { createContainer, startContainer, ... } from "@/lib/docker"
  - Container names: clawdeploy-{instanceId}
  - Labels: clawdeploy=true, instanceId=X
---

## 2026-02-14 08:05 - US-005: Integrate Docker with Instance Creation and Deletion APIs
- POST /api/instances now creates Docker container after DB insert
- DELETE /api/instances/[id] now removes container before DB delete
- Added serverExternalPackages: ["dockerode", "ssh2"] to next.config.ts
- **Learnings for future iterations:**
  - next.config.ts needs serverExternalPackages for dockerode to work in API routes
  - Docker operations wrapped in try/catch so DB ops continue even if Docker fails
---

## 2026-02-14 08:10 - US-006: Add Container Action API Endpoints (Start / Stop / Logs)
- Created start/route.ts, stop/route.ts, logs/route.ts under api/instances/[id]/
- All follow existing auth/validation patterns
- Logs endpoint supports ?tail=N query param
- **Learnings for future iterations:**
  - API routes at: /api/instances/[id]/start, /api/instances/[id]/stop, /api/instances/[id]/logs
  - All use POST except logs which uses GET
  - RouteContext type: { params: Promise<{ id: string }> }
---

## 2026-02-14 08:15 - US-007: Create Instance Creation Page (/dashboard/new)
- Created frontend/src/app/dashboard/new/page.tsx
- Client component with form: name, model, channel, botToken, apiKey
- Uses existing UI components (Input, Select, Button, Card)
- Client-side validation, POST to /api/instances, redirect on success
- **Learnings for future iterations:**
  - Client components need 'use client' directive
  - useUser() from @clerk/nextjs for client-side auth
  - useRouter() from next/navigation for programmatic navigation
---

## 2026-02-14 08:20 - US-008: Make Dashboard Page Dynamic with Real Instance Data
- Converted dashboard/page.tsx to client component
- Fetches instances from GET /api/instances on mount
- Shows instance cards with name, model, channel, status badge, creation date
- Links to /dashboard/instances/[id]
- Empty state with create button
- **Learnings for future iterations:**
  - fetch("/api/instances") works in client components (relative URL)
  - Badge variant mapping: running→success, pending/creating→warning, error→danger, stopped→default
---

## 2026-02-14 08:25 - US-009: Create Instance Detail Page (/dashboard/instances/[id])
- Created frontend/src/app/dashboard/instances/[id]/page.tsx
- Shows instance info card + container logs card
- Fetches from /api/instances/{id} and /api/instances/{id}/logs
- Back to Dashboard link, status badge, formatted dates
- **Learnings for future iterations:**
  - useParams() from next/navigation for dynamic route params
  - Logs displayed in dark monospace <pre> block with max-h-[400px]
---

## 2026-02-14 08:35 - US-010: Add Start / Stop / Delete Action Buttons in UI
- Created frontend/src/components/InstanceActions.tsx shared component
- Integrated into dashboard page and instance detail page
- Start/Stop/Delete with loading states, confirmation modal for delete
- **Learnings for future iterations:**
  - InstanceActions at frontend/src/components/InstanceActions.tsx
  - Uses e.stopPropagation() to prevent Link navigation on button click
  - Modal component from @/components/ui for delete confirmation
---

## 2026-02-14 08:40 - US-011: Instance State Sync (Container Status Polling)
- Created frontend/src/lib/state-sync.ts with syncInstanceStates()
- Created POST /api/admin/sync endpoint (X-Sync-Secret auth)
- Dashboard polls every 30s
- **Learnings for future iterations:**
  - state-sync.ts at frontend/src/lib/state-sync.ts
  - Admin sync: POST /api/admin/sync with X-Sync-Secret header
  - SYNC_SECRET=clawdeploy-sync-2026 in .env.local
---
